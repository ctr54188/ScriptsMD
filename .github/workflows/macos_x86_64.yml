name: macOS x86_64 Build
on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - '.github/workflows/macos_x86_64.yml'

jobs:
  build:
    runs-on: macos-13
    env:
      TZ: Asia/Shanghai
      PYTHON_VERSION: "3.14.1"
      MACOSX_DEPLOYMENT_TARGET: "10.15"

    steps:
      - uses: actions/checkout@v4
        with:
          architecture: x64

      - name: Install x86_64 Python via pyenv
        run: |
          # å®‰è£…ç¼–è¯‘ä¾èµ–
          brew install openssl readline sqlite3 xz zlib tcl-tk
          
          # å®‰è£… pyenv
          brew install pyenv
          echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
          echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
          echo 'eval "$(pyenv init --path)"' >> ~/.bashrc
          source ~/.bashrc
          
          # å¼ºåˆ¶å®‰è£… x86_64 ç‰ˆæœ¬ Python
          arch -x86_64 pyenv install $PYTHON_VERSION --verbose
          pyenv global $PYTHON_VERSION
          
          # éªŒè¯æž¶æž„
          python -c "import platform; print('Python Arch:', platform.machine())"
          which python

      - name: Set up Python PATH
        run: |
          echo "$HOME/.pyenv/shims" >> $GITHUB_PATH
          echo "$HOME/.pyenv/bin" >> $GITHUB_PATH

      - name: Verify Python
        run: |
          python --version
          pip --version
          python -c "import platform; print(platform.machine())"

      - name: Install build tools
        run: |
          # å¼ºåˆ¶ x86_64 ç¼–è¯‘çŽ¯å¢ƒ
          export ARCHFLAGS="-arch x86_64"
          export CC="clang -arch x86_64"
          export CXX="clang++ -arch x86_64"
          
          # éªŒè¯å®‰è£…
          echo "å½“å‰System Pythonè·¯å¾„: $(which python)"
          echo "å½“å‰System Pythonç‰ˆæœ¬: $(python --version)"
          echo "å½“å‰System pipç‰ˆæœ¬: $(pip --version)"
          
          python -m pip install --upgrade pip
          pip install --no-cache-dir uv
          uv venv
          source .venv/bin/activate
          
          echo "å½“å‰Pythonè·¯å¾„: $(which python)"
          echo "å½“å‰Pythonç‰ˆæœ¬: $(python --version)"
          echo "å½“å‰pipç‰ˆæœ¬: $(pip --version)"
          
          uv pip install --no-cache-dir -r requirements.txt
          pyinstaller --onefile --console --collect-all=openpyxl --name="InsertImagesB" insert_images_b.py
          
          # éªŒè¯æž¶æž„
          file dist/start_macos
          lipo -archs dist/start_macos

      - name: Prepare artifacts
        run: |
          cp sdk/.env dist/
          # åˆ›å»º ZIP åŒ…
          zip -r macos_x86_64.zip dist/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-build
          path: macos_x86_64.zip

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            macos_x86_64.zip
          tag_name: v1.0.0
          name: Release v1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        run: |
          echo "### ðŸ–¥ï¸ x86_64 Build Report" >> $GITHUB_STEP_SUMMARY
          echo "- Python: $(python --version)" >> $GITHUB_STEP_SUMMARY
